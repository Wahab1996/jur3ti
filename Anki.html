<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>مولّد Anki من نص — أنيق وسهل</title>
<meta name="color-scheme" content="dark light">
<style>
  /* ===== Theme ===== */
  :root{
    --bg: #0b1220;
    --surface: #0e1628;
    --surface-2:#111c32;
    --border:#1f2a44;
    --text:#e5eaf3;
    --muted:#9aa4b2;
    --accent:#22c55e;
    --accent-2:#38bdf8;
    --radius:14px;
    --shadow:0 10px 30px rgba(0,0,0,.25);
    --gap:14px;
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f6f7fb; --surface:#ffffff; --surface-2:#f2f5fb; --border:#e6e8ee; --text:#0f172a; --muted:#5b6473; --shadow:0 8px 28px rgba(2,6,23,.08); }
    body{ background: linear-gradient(180deg,#f7fbff, #f6f7fb 40%); }
  }

  /* ===== Layout ===== */
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{ margin:0; font-family: system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; background: radial-gradient(1200px 600px at 80% -100px, rgba(56,189,248,.10), transparent 60%), radial-gradient(900px 500px at -10% -40px, rgba(34,197,94,.08), transparent 55%), var(--bg); color:var(--text); }

  .wrap{ max-width:1150px; margin:32px auto; padding:0 18px; }
  .card{ background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden }

  header.app{ position:sticky; top:0; z-index:10; background:linear-gradient(135deg, rgba(56,189,248,.16), rgba(34,197,94,.12)); border-bottom:1px solid var(--border); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); }
  .head-inner{ display:flex; align-items:center; justify-content:space-between; padding:16px 18px }
  h1{ margin:0; font-size:18px; letter-spacing:.2px }
  .subtitle{ font-size:12px; opacity:.9 }

  .grid{ display:grid; gap:var(--gap); grid-template-columns:1fr; padding:16px; }
  @container (min-width: 800px){}
  @media (min-width: 980px){ .grid.cols{ grid-template-columns: 1.25fr .85fr } }

  /* ===== Controls ===== */
  label{ font-size:12px; color:var(--muted); display:block; margin:6px 0 }
  textarea, input[type="text"], select{ width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:var(--surface); color:var(--text); outline:none; }
  textarea{ min-height:420px; line-height:1.7; resize:vertical }
  input:focus, textarea:focus, select:focus{ border-color: color-mix(in oklch, var(--accent) 60%, white 0%); box-shadow:0 0 0 4px color-mix(in oklch, var(--accent) 20%, transparent 80%); }

  .panel{ display:grid; gap:var(--gap) }
  .row{ display:grid; gap:10px; grid-template-columns:1fr 1fr }
  @media (max-width:640px){ .row{ grid-template-columns:1fr } }

  .inline{ display:flex; align-items:center; gap:8px }
  .muted{ color:var(--muted); font-size:12px }
  .badge{ display:inline-flex; align-items:center; gap:6px; padding:4px 10px; background:var(--surface-2); border:1px solid var(--border); border-radius:999px; font-size:12px }

  .bar{ display:flex; flex-wrap:wrap; gap:8px }
  button{ padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:var(--surface-2); color:var(--text); cursor:pointer; font-weight:700; transition: transform .04s ease, background .2s ease, border-color .2s ease; }
  button:hover{ transform: translateY(-1px) }
  button.primary{ background: color-mix(in oklch, var(--accent) 85%, black 15%); color:#071d11; border-color: color-mix(in oklch, var(--accent) 70%, black 30%); }
  button.ghost{ background:transparent }
  button:active{ transform: translateY(0) scale(.99) }

  .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:11px; padding:2px 6px; border-radius:6px; background:var(--surface-2); border:1px solid var(--border) }

  /* ===== Preview Table ===== */
  .tbl-wrap{ border:1px solid var(--border); border-radius:12px; overflow:auto; background:var(--surface); }
  table{ width:100%; border-collapse:separate; border-spacing:0; min-width:680px }
  th, td{ text-align:start; padding:10px 12px; border-bottom:1px solid var(--border); vertical-align:top; }
  th{ position:sticky; top:0; background:linear-gradient(180deg, var(--surface-2), var(--surface)); z-index:1 }
  tbody tr:hover td{ background: rgba(56,189,248,.05) }

  .footer{ padding:14px 16px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; border-top:1px solid var(--border); background: linear-gradient(180deg, transparent, rgba(255,255,255,.02)); }
  .pill{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }

  /* Small helpers */
  .spacer{ height:6px }
  .note{ font-size:12px; opacity:.85 }
  .right{ margin-inline-start:auto }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="app">
      <header class="app">
        <div class="head-inner">
          <div style="display:flex; align-items:center; gap:10px">
            <div class="badge" title="يدعم Basic • Cloze • MCQ • Front,Back">
              <span>🧠</span>
              <span>Basic • Cloze • MCQ • Front,Back</span>
            </div>
            <h1>مولّد ملف Anki من نص</h1>
          </div>
          <div class="subtitle">يحفظ مدخلاتك تلقائيًا • يعمل محليًا</div>
        </div>
      </header>

      <div class="grid cols">
        <section>
          <label for="inputText">الصق النص هنا</label>
          <textarea id="inputText" placeholder="مثال لصيغتك بالضبط:\nFront,Back\nPreferred insulin delivery method for T1DM?<br>A) ...<br>B) ... ,B) ...\n..."></textarea>

          <div class="spacer"></div>
          <details class="help" style="background:var(--surface-2); border:1px dashed var(--border); padding:12px; border-radius:12px;">
            <summary style="cursor:pointer; font-weight:700">كيف تَكتب الإدخال؟</summary>
            <ul style="line-height:1.9; margin:8px 0 0 0; padding-inline-start:18px">
              <li><b>Front,Back (MCQ بصيغتك):</b> أول سطر <code>Front,Back</code> ثم كل سطر: <code>Front,Back</code>. نفصل عند <u>آخر فاصلة</u> بالسطر.</li>
              <li><b>MCQ (حر):</b> فقرة لكل سؤال وخيارات، والصحيح يوضع في Back أو أشر له بنجمة.</li>
              <li><b>Q→A</b> و<b>Cloze</b> كما سبق. الناتج CSV بترميز UTF‑8 + BOM.</li>
            </ul>
            <div class="muted">تلميح: استخدم <span class="kbd">Shift+Enter</span> لسطر جديد داخل الواجهة.</div>
          </details>
        </section>

        <aside class="panel">
          <div class="row">
            <div>
              <label for="mode">الوضع</label>
              <select id="mode">
                <option value="frontback">Front,Back (صيغة جاهزة)</option>
                <option value="mcq">MCQ (اختيار من متعدد)</option>
                <option value="qa">سؤال → جواب (Q→A)</option>
                <option value="cloze">Cloze (إخفاء)</option>
                <option value="one">سطر → بطاقة (وجه واحد)</option>
              </select>
            </div>
            <div>
              <label for="deck">اسم المجموعة (Deck) — اختياري</label>
              <input id="deck" type="text" placeholder="مثال: Diabetes MCQs">
            </div>
          </div>

          <div id="qaOptions" style="display:none;">
            <div class="row">
              <div>
                <label for="delimiter">الفاصل لـ Q→A</label>
                <input id="delimiter" type="text" value="::">
              </div>
              <div>
                <label for="tags">وسوم (Tags) — اختياري</label>
                <input id="tags" type="text" placeholder="مثال: MCQ;exam">
              </div>
            </div>
          </div>

          <div class="inline" style="margin-top:6px">
            <input type="checkbox" id="letterOnly">
            <label for="letterOnly" class="inline">جعل <b>Back</b> حرف الخيار فقط (مثل: B)</label>
          </div>

          <div class="bar" style="margin-top:10px">
            <button id="previewBtn" title="معاينة (Ctrl/⌘+Enter)">معاينة</button>
            <button id="downloadBtn" class="primary" title="تنزيل CSV (Ctrl/⌘+S)">تنزيل CSV</button>
            <button id="clearBtn" class="ghost" title="تفريغ الحقول">تفريغ</button>
            <button id="sampleBtn" class="ghost" title="ملء مثال سريع">ملء مثال</button>
          </div>

          <div class="bar" style="margin-top:6px">
            <input type="file" id="importFile" accept=".txt,.csv" style="display:none">
            <button id="importBtn" class="ghost" title="استيراد نص من ملف .txt أو .csv">استيراد ملف</button>
            <button id="copyCsvBtn" class="ghost" title="نسخ CSV إلى الحافظة">نسخ CSV</button>
          </div>

          <div class="note">في الاستيراد اختر نوع المذكرة <b>Basic</b>، واربط الأعمدة: Front → Back.</div>
          <div class="muted">اختصارات: <span class="kbd">Ctrl/⌘ + Enter</span> معاينة • <span class="kbd">Ctrl/⌘ + S</span> تنزيل</div>
        </aside>
      </div>

      <div class="grid" style="grid-template-columns:1fr; padding-top:0">
        <section>
          <div style="display:flex; align-items:center; gap:10px; justify-content:space-between">
            <label>المعاينة <span class="muted">(أول 100 بطاقة)</span></label>
            <div class="muted" id="stats">—</div>
          </div>
          <div class="tbl-wrap" id="preview"></div>
        </section>
      </div>

      <div class="footer">
        <div class="pill">
          <span class="note">يدعم &lt;br&gt; داخل الواجهة الأمامية.</span>
          <span class="note">يحفظ الإعدادات تلقائيًا في المتصفح.</span>
          <span class="note">يعمل محليًا — بدون إنترنت.</span>
        </div>
        <div class="pill right">
          <span class="badge">إجمالي البطاقات: <b id="totalCount">0</b></span>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const inputText = $('#inputText');
  const mode = $('#mode');
  const deck = $('#deck');
  const delimiter = $('#delimiter');
  const tagsInput = $('#tags');
  const qaOptions = $('#qaOptions');
  const letterOnly = $('#letterOnly');
  const previewEl = $('#preview');
  const previewBtn = $('#previewBtn');
  const downloadBtn = $('#downloadBtn');
  const clearBtn = $('#clearBtn');
  const sampleBtn = $('#sampleBtn');
  const copyCsvBtn = $('#copyCsvBtn');
  const importBtn = $('#importBtn');
  const importFile = $('#importFile');
  const totalCountEl = $('#totalCount');
  const statsEl = $('#stats');

  const LS_KEY = 'anki-gen-state-v2';
  restoreState();

  mode.addEventListener('change', ()=>{
    qaOptions.style.display = (mode.value === 'qa') ? 'grid' : 'none';
    saveState();
    renderPreview();
  });
  [deck, delimiter, tagsInput, letterOnly].forEach(el=> el && el.addEventListener('input', ()=>{ saveState(); renderPreview(); }));

  clearBtn.addEventListener('click', ()=>{
    if(!confirm('متأكد من تفريغ المدخلات؟')) return;
    inputText.value = '';
    saveState();
    renderPreview();
  });

  sampleBtn.addEventListener('click', ()=>{
    inputText.value = `Front,Back\nWhich of the following best describes the pathogenesis of type 1 diabetes mellitus (T1DM)?<br>A) Insulin resistance due to obesity<br>B) Autoimmune destruction of β-cells in the pancreas<br>C) Mutation in the glucokinase gene<br>D) Amyloid deposition in islets,B) Autoimmune destruction of β-cells in the pancreas\n\nWhat is the first-line therapy for type 2 diabetes in most patients?<br>A) Insulin<br>B) Sulfonylureas<br>C) Metformin<br>D) Thiazolidinediones,C) Metformin`;
    mode.value = 'frontback';
    saveState();
    renderPreview();
  });

  previewBtn.addEventListener('click', renderPreview);
  inputText.addEventListener('input', debounce(()=>{ saveState(); renderPreview(); }, 250));

  // keyboard shortcuts
  document.addEventListener('keydown', (e)=>{
    const meta = e.ctrlKey || e.metaKey;
    if(meta && e.key === 'Enter'){ e.preventDefault(); renderPreview(); }
    if(meta && (e.key === 's' || e.key === 'S')){ e.preventDefault(); downloadCSV(); }
  });

  downloadBtn.addEventListener('click', downloadCSV);
  copyCsvBtn.addEventListener('click', async ()=>{
    const {rows, headers} = buildRows();
    if(!rows.length){ alert('لا توجد بطاقات للنسخ.'); return; }
    const csv = toCSV([headers, ...rows]);
    try{
      await navigator.clipboard.writeText('\uFEFF' + csv);
      copyCsvBtn.textContent = '✓ تم النسخ';
      setTimeout(()=> copyCsvBtn.textContent = 'نسخ CSV', 1200);
    }catch(err){ alert('تعذّر النسخ إلى الحافظة.'); }
  });

  importBtn.addEventListener('click', ()=> importFile.click());
  importFile.addEventListener('change', async ()=>{
    const f = importFile.files[0];
    if(!f) return;
    const txt = await f.text();
    inputText.value = txt; saveState(); renderPreview();
  });

  function downloadCSV(){
    const {rows, headers} = buildRows();
    if(!rows.length){ alert('لا توجد بطاقات للتصدير.'); return; }
    const csv = toCSV([headers, ...rows]);
    const deckName = (deck.value || 'anki').trim().replace(/[\\/:*?"<>|]+/g,'-');
    const blob = new Blob([bomUtf8()+csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `${deckName || 'anki'}.csv`;
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }

  function buildRows(){
    const text = (inputText.value || '').replace(/\r\n/g, '\n');
    const tagString = normalizeTags(tagsInput?.value || '');
    const deckName = (deck.value || '').trim();

    if(mode.value === 'frontback'){
      return parseFrontBack(text, deckName, tagString);
    }

    if(mode.value === 'qa'){
      const delim = delimiter.value || '::';
      const lines = text.split('\n').map(s=>s.trim()).filter(Boolean);
      const rows = lines.map(line=>{
        const idx = line.indexOf(delim);
        let front = line, back = '';
        if(idx >= 0){ front = line.slice(0, idx).trim(); back  = line.slice(idx + delim.length).trim(); }
        return [front, back, deckName, tagString];
      });
      return { headers: ['Front','Back','Deck','Tags'], rows };
    }

    if(mode.value === 'one'){
      const lines = text.split('\n').map(s=>s.trim()).filter(Boolean);
      const rows = lines.map(line=>[line, '', deckName, tagString]);
      return { headers: ['Front','Back','Deck','Tags'], rows };
    }

    if(mode.value === 'cloze'){
      const chunks = splitParagraphs(text).filter(s=>s.trim().length>0);
      const rows = chunks.map(ch => [ch.trim(), deckName, tagString]);
      return { headers: ['Text','Deck','Tags'], rows };
    }

    // MCQ (حر) — فقرة لكل سؤال
    const paras = splitParagraphs(text).filter(p=>p.trim().length>0);
    const rows = [];
    for(const p of paras){
      const parsed = parseMCQParagraph(p);
      if(parsed){
        const {question, options, correctIndex} = parsed;
        const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        const optLines = options.map((opt,i)=>`${letters[i]}. ${opt}`).join('<br>');
        const front = `${question}<br><br>${optLines}`;
        let back = '';
        if(correctIndex != null){
          const L = letters[correctIndex];
          back = letterOnly.checked ? L : `${L}. ${options[correctIndex]}`;
        }
        rows.push([front, back, deckName, tagString]);
      }
    }
    return { headers: ['Front','Back','Deck','Tags'], rows };
  }

  // ====== Front,Back parser (يفصل عند آخر فاصلة) ======
  function parseFrontBack(text, deckName, tagString){
    const lines = text.split('\n').map(s=>s.trim()).filter(Boolean);
    const rows = [];
    let startIndex = 0;
    if(lines.length && /^front\s*,\s*back$/i.test(lines[0])) startIndex = 1;

    for(let i=startIndex; i<lines.length; i++){
      const line = lines[i];
      const lastComma = line.lastIndexOf(',');
      if(lastComma === -1) continue;

      const front = line.slice(0, lastComma).trim();
      let back = line.slice(lastComma+1).trim();

      if(letterOnly.checked){
        const letter = deriveLetterFromFrontBack(front, back);
        if(letter) back = letter; // إن قدر يحدد الحرف، يحوله لحرف فقط
      }

      rows.push([front, back, deckName, tagString]);
    }
    return { headers: ['Front','Back','Deck','Tags'], rows };
  }

  // يستخرج حرف الخيار من Front/Back
  function deriveLetterFromFrontBack(front, back){
    // 1) لو Back يبدأ بحرف خيار واضح
    const m1 = back.match(/^\s*([A-Za-z])\s*[\)\.\-]?\s/);
    if(m1) return m1[1].toUpperCase();

    // 2) جرّب مطابقته بنص أحد الخيارات الموجودين في Front
    const opts = extractOptionLinesFromFront(front); // [{letter:'A', text:'...'}]
    const nb = normalize(back);
    const byText = opts.find(o => normalize(o.text) === nb);
    if(byText) return byText.letter;

    // 3) لو Back يساوي حرفًا منفردًا أصلًا
    const m2 = back.match(/^\s*([A-Za-z])\s*$/);
    if(m2) return m2[1].toUpperCase();

    return '';
  }

  function extractOptionLinesFromFront(front){
    // front يحتوي <br>؛ نقسمه ونلتقط خطوط بصيغة "A) ..." أو "A. ..."
    const parts = front.split(/<br\s*\/?>(?![^]*<br)/i).map(s=>s.trim()).filter(Boolean);
    const all = front.split(/<br\s*\/?/i).map(s=>s.trim()).filter(Boolean);
    const out = [];
    for(const ln of all){
      const m = ln.match(/^\s*([A-Za-z])\s*[\)\.\-]\s*(.+)$/);
      if(m){ out.push({letter: m[1].toUpperCase(), text: m[2].trim()}); }
    }
    return out;
  }

  // ====== MCQ paragraph parser ======
  function parseMCQParagraph(p){
    const lines = p.split('\n').map(s=>s.trim()).filter(Boolean);
    if(!lines.length) return null;
    const question = lines[0];
    const rest = lines.slice(1);

    let options = [];
    let answerExplicit = null;

    for(const ln of rest){
      const m = ln.match(/^(?:answer|ans|correct)\s*[:\-]\s*(.+)$/i);
      if(m){ answerExplicit = m[1].trim(); }
    }

    for(let ln of rest){
      if(/^(?:answer|ans|correct)\s*[:\-]/i.test(ln)) continue;
      let m;
      m = ln.match(/^(?:[-•▪—–]|\*)\s*(.+)$/); if(m){ options.push(m[1].trim()); continue; }
      m = ln.match(/^[A-Za-z]\s*[\)\.\-]\s*(.+)$/); if(m){ options.push(m[1].trim()); continue; }
      if(options.length>0){ options.push(ln); }
    }
    if(options.length===0) return null;

    let correctIndex = null;
    for(let i=0;i<rest.length;i++){
      const raw = rest[i];
      if(/^(?:answer|ans|correct)\s*[:\-]/i.test(raw)) continue;
      const starStart = raw.match(/^\*\s*(.+)$/);
      const starEnd   = raw.match(/^(.+?)\s*\*$/);
      if(starStart || starEnd){
        const clean = (starStart? starStart[1] : starEnd[1]).trim();
        const idx = options.findIndex(o=>normalize(o)===normalize(clean));
        if(idx>=0) correctIndex = idx;
      }
    }

    if(answerExplicit && correctIndex==null){
      const ans = answerExplicit.trim();
      const letter = ans.match(/^[A-Za-z]$/) || ans.match(/^[A-Za-z][\)\.\-]?$/);
      if(letter){
        const L = ans[0].toUpperCase();
        const idx = L.charCodeAt(0) - 65;
        if(idx>=0 && idx<options.length) correctIndex = idx;
      } else {
        const idxByText = options.findIndex(o=>normalize(o)===normalize(ans));
        if(idxByText>=0) correctIndex = idxByText;
      }
    }
    return {question, options, correctIndex};
  }

  // ===== Helpers =====
  function toCSV(rows){ return rows.map(r => r.map(csvEscape).join(',')).join('\n'); }
  function csvEscape(v){ v = (v ?? '').toString(); if(/[",\n]/.test(v)){ v = '"' + v.replace(/"/g,'""') + '"'; } return v; }
  function escapeHtml(s){ return (s??'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
  function escapeHtmlHTML(s){ const safe = escapeHtml(s); return safe.replace(/&lt;br&gt;/g,'<br>'); }
  function splitParagraphs(t){ return t.split(/\n\s*\n+/); }
  function normalize(s){ return (s||'').toString().replace(/\s+/g,' ').trim().toLowerCase(); }
  function normalizeTags(s){ return (s||'').trim().replace(/[;,]+/g,' ').replace(/\s+/g,' '); }
  function bomUtf8(){ return '\uFEFF'; }
  function debounce(fn, ms){ let id; return (...a)=>{ clearTimeout(id); id=setTimeout(()=>fn.apply(null,a),ms);} }

  function saveState(){
    const state = {
      text: inputText.value,
      mode: mode.value,
      deck: deck.value,
      delimiter: delimiter?.value || '::',
      tags: tagsInput?.value || '',
      letterOnly: !!letterOnly.checked,
    };
    try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }catch(_){ }
  }
  function restoreState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return;
      const s = JSON.parse(raw);
      if(typeof s.text === 'string') inputText.value = s.text;
      if(s.mode) mode.value = s.mode;
      if(typeof s.deck === 'string') deck.value = s.deck;
      if(typeof s.delimiter === 'string' && delimiter) delimiter.value = s.delimiter;
      if(typeof s.tags === 'string' && tagsInput) tagsInput.value = s.tags;
      if(typeof s.letterOnly === 'boolean') letterOnly.checked = s.letterOnly;
      qaOptions.style.display = (mode.value === 'qa') ? 'grid' : 'none';
    }catch(_){ }
  }

  function renderPreview(){
    const t0 = performance.now();
    const {rows, headers} = buildRows();
    const max = Math.min(rows.length, 100);
    totalCountEl.textContent = rows.length;

    if(max === 0){ previewEl.innerHTML = '<div class="muted" style="padding:16px">لا توجد معاينة بعد.</div>'; statsEl.textContent = '—'; return; }

    const head = '<thead><tr>' + headers.map(h=>`<th>${escapeHtml(h)}</th>`).join('') + '</tr></thead>';
    const body = '<tbody>' + rows.slice(0, max).map(r => '<tr>'+ r.map(c=>`<td>${escapeHtmlHTML(c)}</td>`).join('') + '</tr>').join('') + '</tbody>';
    previewEl.innerHTML = `<table>${head}${body}</table>`;

    const dt = Math.max(1, Math.round(performance.now() - t0));
    statsEl.textContent = `المعروض ${max} / ${rows.length} • الزمن ${dt}ms`;
  }

  // أول معاينة
  renderPreview();
})();
</script>
</body>
</html>
