<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CSV Generator for Anki</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;direction:rtl;padding:18px;background:#f7f8fb;color:#111}
    h1{font-size:18px;margin:0 0 12px}
    textarea{width:100%;height:340px;padding:10px;font-size:14px;box-sizing:border-box;resize:vertical}
    .row{display:flex;gap:8px;margin-top:10px}
    button{padding:10px 14px;border:0;background:#0b74de;color:white;border-radius:8px;cursor:pointer}
    button.secondary{background:#6c757d}
    label{display:flex;align-items:center;gap:8px;font-size:14px}
    .note{font-size:13px;color:#444;margin-top:8px}
    .out{margin-top:12px;word-break:break-word}
    .small{font-size:13px;color:#333}
  </style>
</head>
<body>
  <h1>مولّد ملف CSV لأنكي — الصق النص ثم حمّل الملف</h1>

  <label class="small">1) الصق هنا نص البطاقات (بصيغة CSV: <code>Front,Back</code>) أو الصق النص كما في المحادثة:</label>
  <textarea id="inputArea" placeholder="أمثلة مقبولة:
Front,Back
سؤال 1?,إجابة 1
... أو الصق النص الذي يولّد أسئلة مع خيارات مثل: Preferred insulin delivery method for T1DM?<br>A) ..."></textarea>

  <div class="row">
    <label><input type="checkbox" id="stripHtml" checked> إزالة وسوم &lt;br&gt; وتحويلها إلى فواصل أسطر داخل حقل السؤال</label>
  </div>

  <div class="row">
    <button id="generateBtn">إنشاء ملف CSV للأنكي</button>
    <button id="clearBtn" class="secondary">مسح</button>
  </div>

  <div class="note" id="hint">
    ملاحظة: هذا مولّد CSV فقط. الملف الناتج قابل للاستيراد في AnkiMobile/Anki Desktop كنمط "Basic". إذا أردت ملف <code>.apkg</code> فذلك يتطلب أدوات (مثل genanki) على جهاز الكمبيوتر.
  </div>

  <div class="out" id="outputInfo"></div>

<script>
(function(){
  const input = document.getElementById('inputArea');
  const generateBtn = document.getElementById('generateBtn');
  const clearBtn = document.getElementById('clearBtn');
  const outputInfo = document.getElementById('outputInfo');
  const stripHtml = document.getElementById('stripHtml');

  // Example prefill (optional) — comment out if undesired
  input.value = `Front,Back
Preferred insulin delivery method for T1DM?<br>A) Single daily injection<br>B) Multiple daily injections or insulin pump<br>C) Oral agents<br>D) Sliding-scale insulin only,B) Multiple daily injections or insulin pump
Usual starting insulin dose for T1DM (units/kg/day)?<br>A) 0.1<br>B) 0.25<br>C) 0.5<br>D) 1.5,C) 0.5
Ratio of basal to prandial insulin in T1DM?<br>A) 70/30<br>B) 60/40<br>C) 50/50<br>D) 40/60,C) 50/50
What happens to insulin needs during the “honeymoon phase” of T1DM?<br>A) Increase<br>B) Stay same<br>C) Decrease<br>D) Stop entirely,C) Decrease`;

  function sanitizeLine(line) {
    // Remove code fences if pasted
    line = line.replace(/^```.+/g,'').replace(/```/g,'').trim();
    return line;
  }

  function htmlBreakToNewline(text) {
    // Replace <br> and variants with literal newline inside the Front field (keeps readability in Anki)
    return text.replace(/<br\s*\/?>/gi,'\\n');
  }

  function csvEscape(field) {
    // Escape double quotes by doubling them, and wrap in quotes if needed
    if (field == null) field = '';
    const needs = /[,"\n\r]/.test(field);
    let v = String(field);
    v = v.replace(/"/g,'""');
    return needs ? `"${v}"` : v;
  }

  function prepareCSV(raw) {
    const lines = raw.split(/\r?\n/).map(sanitizeLine).filter(l=>l.trim()!=='');
    // If first line starts with Front,Back treat it as header and keep
    let hasHeader = false;
    if (lines.length && /^front\s*,\s*back$/i.test(lines[0])) {
      hasHeader = true;
      lines.shift(); // remove header for processing; we'll add proper header later
    }

    const rows = [];
    for (let i=0;i<lines.length;i++){
      let line = lines[i];

      // If the line already looks like CSV with a comma separating front and back
      if (line.indexOf(',') !== -1) {
        // Split only on the first comma to allow commas in answers
        const idx = line.indexOf(',');
        let front = line.slice(0, idx).trim();
        let back = line.slice(idx+1).trim();

        if (stripHtml.checked) front = htmlBreakToNewline(front);
        // Convert any HTML entities basic (like &lt; &gt;) — minimal
        front = front.replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&amp;/g,'&');

        rows.push([front, back]);
        continue;
      }

      // Otherwise — try to parse block: question line followed by answer line
      // Look ahead: if next line exists, use it as back
      if (i+1 < lines.length) {
        const front = line;
        const back = lines[i+1];
        if (stripHtml.checked) rows.push([htmlBreakToNewline(front), back]);
        else rows.push([front, back]);
        i++; // skip next line
      } else {
        // single leftover line -> treat as front with empty back
        rows.push([line, '']);
      }
    }

    // Build CSV content with UTF-8 BOM to ensure Arabic shows correctly in some apps
    const BOM = '\uFEFF';
    const header = 'Front,Back';
    const csvLines = rows.map(r => `${csvEscape(r[0])},${csvEscape(r[1])}`);
    return BOM + header + "\n" + csvLines.join("\n");
  }

  function download(filename, content) {
    const blob = new Blob([content], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 500);
  }

  generateBtn.addEventListener('click', () => {
    const raw = input.value;
    if (!raw.trim()) {
      outputInfo.innerHTML = '<span style="color:#b00">الرجاء لصق نص البطاقة أولاً.</span>';
      return;
    }
    try {
      const csv = prepareCSV(raw);
      const filename = 'Diabetes_MCQ_Flashcards.csv';
      download(filename, csv);
      outputInfo.innerHTML = `<span style="color:green">تم إنشاء الملف: <strong>${filename}</strong> — افتحه في AnkiMobile أو استورده في Anki Desktop.</span>`;
    } catch (e) {
      outputInfo.innerHTML = `<span style="color:#b00">خطأ أثناء الإنشاء: ${e.message}</span>`;
    }
  });

  clearBtn.addEventListener('click', () => {
    input.value = '';
    outputInfo.innerHTML = '';
  });

})();
</script>
</body>
</html>